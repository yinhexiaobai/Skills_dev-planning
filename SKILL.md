---
name: dev-planning
description: >
  在开始任何编码任务前，先进行开发规划。当用户要求实现功能、开发模块、
  创建项目、重构代码、修复 Bug（非单行修复）时触发。
  强制执行：提问澄清 → 写入开发规划文件 → 再开始编码。
  绝对不允许跳过规划直接写代码。
version: v1.0
---

# 开发规划 Skill

## 核心原则

**任何编码任务都必须先规划，再动手。** 跳过规划直接写代码是不允许的。

---

## 第一步：主动提问（≥ 3 个，强制执行）

在开始规划之前，必须向用户提问，覆盖以下三个维度，每个维度至少提 1 个问题：

### 需求维度（选 1-2 个最相关的提问）

- 这个功能/模块的**核心目标**是什么？解决什么问题？
- 预期的**使用方**是谁（用户、其他系统、定时任务…）？
- 功能的**输入和输出**是什么？有哪些边界或异常情况需要处理？
- 如何判断开发**完成**？有没有验收标准或示例用例？

### 技术维度（选 1-2 个最相关的提问）

- 当前项目使用的**技术栈和框架版本**是什么？
- 项目中是否有**现成模块/工具类**可以复用，还是需要从零开始？
- 是否有**性能、并发、安全**方面的特殊要求（QPS、数据量、鉴权等）？
- 是否需要对接**外部接口或第三方服务**？

### 约束维度（选 1-2 个最相关的提问）

- 是否有**时间**压力或交付节点？
- 是否需要**向后兼容**已有接口或数据库结构？
- 是否有需要遵守的**编码规范、分支规范或部署流程**？
- 是否存在**不能做**的事情（禁止改动的文件、不能引入的依赖等）？

> **提问方式**：将选出的问题整合成一段自然的对话，一次性向用户提出所有问题，
> 不要逐个追问，不要开始写任何代码，等待用户回答后再进入第二步。

---

## 第二步：检测项目类型，确定规划文件路径

根据项目根目录中存在的文件自动判断，**按优先级从高到低匹配**：

| 优先级 | 判断依据 | 项目类型 | 规划文件路径 |
|--------|---------|---------|------------|
| 1 | `pom.xml` 存在 | Java / Maven | `docs/dev-plan.md` |
| 2 | `build.gradle` 或 `build.gradle.kts` 存在 | Java / Gradle 或 Android | `docs/dev-plan.md` |
| 3 | `src/main/java` 目录存在 | Spring Boot | `docs/dev-plan.md` |
| 4 | `pubspec.yaml` 存在 | Dart / Flutter | `docs/dev-plan.md` |
| 5 | `*.xcodeproj` 或 `*.xcworkspace` 目录存在 | iOS / Swift / Xcode | `docs/dev-plan.md` |
| 6 | `Gemfile` 存在 | Ruby / Rails | `docs/dev-plan.md` |
| 7 | `composer.json` 存在 | PHP / Laravel | `docs/dev-plan.md` |
| 8 | `*.csproj` 或 `*.sln` 存在 | .NET / C# | `docs/dev-plan.md` |
| 9 | `pyproject.toml` 存在，或 `requirements.txt` 中含 `torch`/`tensorflow`/`transformers` | Python / AI·ML | `docs/dev-plan.md` |
| 10 | `pyproject.toml` 或 `requirements.txt` 存在（普通 Python） | Python | `docs/dev-plan.md` |
| 11 | `go.mod` 存在 | Go | `docs/dev-plan.md` |
| 12 | `Cargo.toml` 存在 | Rust | `docs/dev-plan.md` |
| 13 | `tsconfig.json` 存在且无 `package.json` | 纯 TypeScript | `DEV_PLAN.md` |
| 14 | `package.json` 且含 `react-native` 依赖 | React Native | `DEV_PLAN.md` |
| 15 | `package.json` 且含 `vue` 或 `nuxt` 依赖 | Vue / Nuxt | `DEV_PLAN.md` |
| 16 | `package.json` 且含 `next` 依赖 | Next.js | `DEV_PLAN.md` |
| 17 | `package.json` 且 `src/` 目录存在 | Node.js / 前端 | `DEV_PLAN.md` |
| 18 | `index.html` 或根目录有 `.html` 文件 | 纯前端 | `DEV_PLAN.md` |
| 19 | 根目录存在多个不同语言的特征文件（Monorepo） | Monorepo | `.claude/dev-plan.md` |
| 20 | 以上均不匹配 | 通用 | `.claude/dev-plan.md` |

**特殊情况：**

- **Monorepo**：若根目录同时存在多种语言特征文件（如同时有 `pom.xml` 和 `package.json`），说明是多语言 Monorepo，规划文件放 `.claude/dev-plan.md`，并在规划中注明影响的子项目
- **AI/ML 项目**：检测到 `requirements.txt` 含有 `torch`、`tensorflow`、`transformers`、`scikit-learn`、`keras`、`jax` 等 ML 依赖时，规划中需额外关注模型版本、GPU 资源、数据集处理等
- 若 `docs/` 目录不存在，**自动创建**
- 若规划文件已存在，在文件末尾**追加新任务规划**（保留历史记录，不覆盖）

---

## 第三步：生成并写入开发规划文件

按以下模板生成规划内容，**所有章节都必须填写**，不留空白占位符：

```markdown
# 开发规划：[任务标题]

> 创建时间：[YYYY-MM-DD HH:MM]
> 状态：规划中

---

## 一、需求分析

### 背景与目标
[用一段话说清楚：为什么要做这件事，要解决什么问题]

### 功能范围
**在范围内：**
- [具体要实现的功能点 1]
- [具体要实现的功能点 2]

**不在范围内（本次不做）：**
- [明确排除的内容，避免范围蔓延]

### 验收标准
- [ ] [可验证的完成条件 1]
- [ ] [可验证的完成条件 2]

---

## 二、技术方案

### 技术选型
| 方面 | 选择 | 理由 |
|------|------|------|
| [框架/库] | [具体选择] | [一句话理由] |

### 模块设计
[简要描述涉及的模块、类、接口、数据库表等，可用文字或简单的结构图]

### 关键接口 / 数据结构
```
[示例：接口签名、数据模型、API 路径等]
```

---

## 三、任务拆分

按照从小到大、可独立完成的原则拆分任务，每个任务预计 1-4 小时内完成：

- [ ] **T1**：[任务名称] — [具体内容，一句话说清楚做什么]
- [ ] **T2**：[任务名称] — [具体内容]
- [ ] **T3**：[任务名称] — [具体内容]
- [ ] **T4**：[任务名称] — [具体内容]（如有）
- [ ] **T5**：[单元测试 / 联调验收]

---

## 四、风险与注意事项

| 风险点 | 可能影响 | 应对措施 |
|--------|---------|---------|
| [风险 1] | [影响范围] | [如何规避或处理] |
| [风险 2] | [影响范围] | [如何规避或处理] |

**编码注意事项：**
- [需要特别注意的技术细节或陷阱]
- [需要遵守的规范或约定]

---

*规划完成，开始执行 T1...*
```

---

## 第四步：规划完成后，再开始编码

规划文件写入完成后，告知用户：
1. 规划文件的路径
2. 本次任务的任务列表摘要（T1、T2...）
3. 即将开始执行哪个任务

然后按任务列表**逐项**推进开发，每完成一个任务，在规划文件中将对应复选框打勾 `[x]`。

---

## 特殊情况处理

| 情况 | 处理方式 |
|------|---------|
| 用户说"直接写代码，不用规划" | 提醒用户规划的价值，但尊重用户决定，记录为跳过规划 |
| 任务极小（如修改一个字符串、改一个配置项） | 跳过规划，直接执行，但需确认任务范围 |
| 规划文件已存在且当前任务有历史规划 | 新规划追加在文件末尾，用 `---` 分隔 |
| 用户在规划阶段修改了需求 | 更新规划文件后再开始编码 |
